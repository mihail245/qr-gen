<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator Pro</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-functions.js"></script>
    
    <!-- QR Code Library -->
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: var(--dark-color);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
            border-color: #c0392b;
        }
        
        #qrcode {
            margin: 20px auto;
            display: flex;
            justify-content: center;
        }
        
        .sidebar {
            background-color: var(--secondary-color);
            min-height: 100vh;
            color: white;
            padding: 20px 0;
        }
        
        .sidebar .nav-link {
            color: var(--light-color);
            margin-bottom: 5px;
            border-radius: 5px;
            padding: 10px 15px;
        }
        
        .sidebar .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            font-weight: 600;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .user-info-card {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .stat-card h3 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 0;
        }
        
        .stat-card p {
            color: var(--dark-color);
            margin-bottom: 0;
        }
        
        .table-responsive {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
        }
        
        .login-container {
            max-width: 500px;
            margin: 50px auto;
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .login-container h2 {
            color: var(--primary-color);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo i {
            font-size: 3rem;
            color: var(--primary-color);
        }
        
        .logo h1 {
            font-weight: 700;
            color: var(--dark-color);
            margin-top: 10px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .qr-options {
            margin-bottom: 20px;
        }
        
        .qr-color-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .qr-color-option label {
            margin-right: 10px;
            min-width: 100px;
        }
        
        .qr-preview-container {
            border: 1px dashed #ccc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            background-color: white;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .user-details {
            display: flex;
            align-items: center;
        }
        
        .map-container {
            height: 300px;
            background-color: #eee;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!-- Toast Notifications -->
    <div class="toast-container"></div>

    <!-- Login Page -->
    <div id="login-page" class="login-container">
        <div class="logo">
            <i class="fas fa-qrcode"></i>
            <h1>QR Code Pro</h1>
        </div>
        <h2>Sign In</h2>
        <form id="login-form">
            <div class="mb-3">
                <label for="login-email" class="form-label">Email address</label>
                <input type="email" class="form-control" id="login-email" required>
            </div>
            <div class="mb-3">
                <label for="login-password" class="form-label">Password</label>
                <input type="password" class="form-control" id="login-password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
        <div class="text-center mt-3">
            <p>Don't have an account? <a href="#" id="show-register">Register</a></p>
        </div>
    </div>

    <!-- Registration Page -->
    <div id="register-page" class="login-container hidden">
        <div class="logo">
            <i class="fas fa-qrcode"></i>
            <h1>QR Code Pro</h1>
        </div>
        <h2>Create Account</h2>
        <form id="register-form">
            <div class="mb-3">
                <label for="register-name" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="register-name" required>
            </div>
            <div class="mb-3">
                <label for="register-email" class="form-label">Email address</label>
                <input type="email" class="form-control" id="register-email" required>
            </div>
            <div class="mb-3">
                <label for="register-password" class="form-label">Password</label>
                <input type="password" class="form-control" id="register-password" required minlength="6">
            </div>
            <div class="mb-3">
                <label for="register-confirm-password" class="form-label">Confirm Password</label>
                <input type="password" class="form-control" id="register-confirm-password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Register</button>
        </form>
        <div class="text-center mt-3">
            <p>Already have an account? <a href="#" id="show-login">Login</a></p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-qrcode me-2"></i>QR Code Pro
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <div class="user-details">
                                    <div class="user-avatar" id="user-avatar">U</div>
                                    <span id="user-name">User</span>
                                </div>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" id="profile-link"><i class="fas fa-user me-2"></i>Profile</a></li>
                                <li><a class="dropdown-item" href="#" id="settings-link"><i class="fas fa-cog me-2"></i>Settings</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logout-link"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-3 col-lg-2 d-md-block sidebar collapse" id="sidebar">
                    <div class="position-sticky pt-3">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" data-section="dashboard">
                                    <i class="fas fa-tachometer-alt"></i> Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="qr-generator">
                                    <i class="fas fa-qrcode"></i> QR Generator
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="my-qrcodes">
                                    <i class="fas fa-history"></i> My QR Codes
                                </a>
                            </li>
                            <li class="nav-item admin-only hidden">
                                <a class="nav-link" href="#" data-section="users">
                                    <i class="fas fa-users"></i> Users
                                </a>
                            </li>
                            <li class="nav-item admin-only hidden">
                                <a class="nav-link" href="#" data-section="analytics">
                                    <i class="fas fa-chart-bar"></i> Analytics
                                </a>
                            </li>
                            <li class="nav-item admin-only hidden">
                                <a class="nav-link" href="#" data-section="settings">
                                    <i class="fas fa-cog"></i> System Settings
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Main Content -->
                <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                    <!-- Dashboard Section -->
                    <div id="dashboard-section" class="content-section">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Dashboard</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <div class="btn-group me-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">
                                    <span data-feather="calendar"></span>
                                    This week
                                </button>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="stat-card">
                                    <h3 id="total-qr-generated">0</h3>
                                    <p>QR Codes Generated</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-card">
                                    <h3 id="total-users">0</h3>
                                    <p>Total Users</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-card">
                                    <h3 id="total-scans">0</h3>
                                    <p>Total Scans</p>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        Recent QR Codes
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover" id="recent-qr-table">
                                                <thead>
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Content</th>
                                                        <th>Scans</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Will be populated by JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        User Activity
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover" id="user-activity-table">
                                                <thead>
                                                    <tr>
                                                        <th>User</th>
                                                        <th>Action</th>
                                                        <th>Time</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Will be populated by JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- QR Generator Section -->
                    <div id="qr-generator-section" class="content-section hidden">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">QR Code Generator</h1>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        Generate QR Code
                                    </div>
                                    <div class="card-body">
                                        <form id="qr-generator-form">
                                            <div class="mb-3">
                                                <label for="qr-content" class="form-label">Content</label>
                                                <textarea class="form-control" id="qr-content" rows="3" placeholder="Enter text, URL, or other content" required></textarea>
                                            </div>
                                            
                                            <div class="mb-3 qr-options">
                                                <label class="form-label">QR Code Options</label>
                                                
                                                <div class="qr-color-option">
                                                    <label for="qr-color">Color:</label>
                                                    <input type="color" id="qr-color" value="#000000">
                                                </div>
                                                
                                                <div class="qr-color-option">
                                                    <label for="qr-bg-color">Background:</label>
                                                    <input type="color" id="qr-bg-color" value="#ffffff">
                                                </div>
                                                
                                                <div class="qr-color-option">
                                                    <label for="qr-size">Size:</label>
                                                    <input type="range" class="form-range" id="qr-size" min="100" max="500" value="200">
                                                    <span id="qr-size-value">200px</span>
                                                </div>
                                                
                                                <div class="qr-color-option">
                                                    <label for="qr-error-correction">Error Correction:</label>
                                                    <select class="form-select" id="qr-error-correction">
                                                        <option value="L">Low (7%)</option>
                                                        <option value="M" selected>Medium (15%)</option>
                                                        <option value="Q">Quartile (25%)</option>
                                                        <option value="H">High (30%)</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-primary">Generate QR Code</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        QR Code Preview
                                    </div>
                                    <div class="card-body">
                                        <div class="qr-preview-container">
                                            <div id="qrcode"></div>
                                        </div>
                                        <div id="qr-result" class="hidden">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h5>Your QR Code</h5>
                                                <div>
                                                    <button id="download-qr" class="btn btn-sm btn-primary me-2">
                                                        <i class="fas fa-download me-1"></i> Download
                                                    </button>
                                                    <button id="save-qr" class="btn btn-sm btn-success">
                                                        <i class="fas fa-save me-1"></i> Save
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="qr-filename" class="form-label">File Name</label>
                                                <input type="text" class="form-control" id="qr-filename" placeholder="Enter file name">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- My QR Codes Section -->
                    <div id="my-qrcodes-section" class="content-section hidden">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">My QR Codes</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <div class="btn-group me-2">
                                    <button class="btn btn-sm btn-outline-secondary" id="refresh-qr-list">
                                        <i class="fas fa-sync-alt me-1"></i> Refresh
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="my-qr-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Name</th>
                                        <th>Content</th>
                                        <th>Scans</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Users Section (Admin Only) -->
                    <div id="users-section" class="content-section hidden">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">User Management</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <div class="btn-group me-2">
                                    <button class="btn btn-sm btn-outline-secondary" id="refresh-users">
                                        <i class="fas fa-sync-alt me-1"></i> Refresh
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="users-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Registered</th>
                                        <th>Last Login</th>
                                        <th>IP</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Analytics Section (Admin Only) -->
                    <div id="analytics-section" class="content-section hidden">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Analytics</h1>
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <div class="btn-group me-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        QR Code Usage
                                    </div>
                                    <div class="card-body">
                                        <canvas id="qr-usage-chart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        User Activity
                                    </div>
                                    <div class="card-body">
                                        <canvas id="user-activity-chart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        User Locations
                                    </div>
                                    <div class="card-body">
                                        <div class="map-container" id="user-locations-map">
                                            <!-- Map will be rendered here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Section (Admin Only) -->
                    <div id="settings-section" class="content-section hidden">
                        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">System Settings</h1>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        General Settings
                                    </div>
                                    <div class="card-body">
                                        <form id="general-settings-form">
                                            <div class="mb-3">
                                                <label for="site-title" class="form-label">Site Title</label>
                                                <input type="text" class="form-control" id="site-title" value="QR Code Pro">
                                            </div>
                                            <div class="mb-3">
                                                <label for="admin-email" class="form-label">Admin Email</label>
                                                <input type="email" class="form-control" id="admin-email" value="alway6offline@gmail.com">
                                            </div>
                                            <div class="mb-3 form-check">
                                                <input type="checkbox" class="form-check-input" id="user-registration" checked>
                                                <label class="form-check-label" for="user-registration">Allow user registration</label>
                                            </div>
                                            <div class="mb-3 form-check">
                                                <input type="checkbox" class="form-check-input" id="qr-tracking" checked>
                                                <label class="form-check-label" for="qr-tracking">Enable QR code tracking</label>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Save Settings</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        Email Settings
                                    </div>
                                    <div class="card-body">
                                        <form id="email-settings-form">
                                            <div class="mb-3">
                                                <label for="smtp-host" class="form-label">SMTP Host</label>
                                                <input type="text" class="form-control" id="smtp-host" placeholder="smtp.example.com">
                                            </div>
                                            <div class="mb-3">
                                                <label for="smtp-port" class="form-label">SMTP Port</label>
                                                <input type="number" class="form-control" id="smtp-port" placeholder="587">
                                            </div>
                                            <div class="mb-3">
                                                <label for="smtp-username" class="form-label">SMTP Username</label>
                                                <input type="text" class="form-control" id="smtp-username" placeholder="username">
                                            </div>
                                            <div class="mb-3">
                                                <label for="smtp-password" class="form-label">SMTP Password</label>
                                                <input type="password" class="form-control" id="smtp-password" placeholder="password">
                                            </div>
                                            <div class="mb-3">
                                                <label for="smtp-security" class="form-label">Security</label>
                                                <select class="form-select" id="smtp-security">
                                                    <option value="tls">TLS</option>
                                                    <option value="ssl">SSL</option>
                                                    <option value="none">None</option>
                                                </select>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Save Email Settings</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Firebase configuration
        const firebaseConfig = { 
            apiKey: "AIzaSyBHsEBhMrk8aHrIYYwYEGC-wRlaPxSyyr0",
            authDomain: "registr-f6a15.firebaseapp.com",
            projectId: "registr-f6a15",
            storageBucket: "registr-f6a15.appspot.com",
            messagingSenderId: "28854335183",
            appId: "1:28854335183:web:8bdb2b09d42850be4c29ba"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();
        
        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const registerPage = document.getElementById('register-page');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        const logoutLink = document.getElementById('logout-link');
        const qrGeneratorForm = document.getElementById('qr-generator-form');
        const qrcodeDiv = document.getElementById('qrcode');
        const qrResult = document.getElementById('qr-result');
        const downloadQrBtn = document.getElementById('download-qr');
        const saveQrBtn = document.getElementById('save-qr');
        const qrFilename = document.getElementById('qr-filename');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const adminOnlyElements = document.querySelectorAll('.admin-only');
        const contentSections = document.querySelectorAll('.content-section');
        const navLinks = document.querySelectorAll('.nav-link');
        const myQrTable = document.getElementById('my-qr-table').getElementsByTagName('tbody')[0];
        const usersTable = document.getElementById('users-table').getElementsByTagName('tbody')[0];
        const refreshQrListBtn = document.getElementById('refresh-qr-list');
        const refreshUsersBtn = document.getElementById('refresh-users');
        const totalQrGenerated = document.getElementById('total-qr-generated');
        const totalUsers = document.getElementById('total-users');
        const totalScans = document.getElementById('total-scans');
        
        // Global variables
        let currentUser = null;
        let currentQRCode = null;
        let userQRs = [];
        let allUsers = [];
        
        // Initialize the app
        function initApp() {
            // Check auth state
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    showApp();
                    loadUserData();
                    checkAdminStatus();
                } else {
                    // User is signed out
                    currentUser = null;
                    showLogin();
                }
            });
            
            // Event listeners
            showRegisterLink.addEventListener('click', e => {
                e.preventDefault();
                loginPage.classList.add('hidden');
                registerPage.classList.remove('hidden');
            });
            
            showLoginLink.addEventListener('click', e => {
                e.preventDefault();
                registerPage.classList.add('hidden');
                loginPage.classList.remove('hidden');
            });
            
            loginForm.addEventListener('submit', e => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                loginUser(email, password);
            });
            
            registerForm.addEventListener('submit', e => {
                e.preventDefault();
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                
                if (password !== confirmPassword) {
                    showToast('Passwords do not match', 'error');
                    return;
                }
                
                registerUser(name, email, password);
            });
            
            logoutLink.addEventListener('click', e => {
                e.preventDefault();
                auth.signOut().then(() => {
                    showToast('Logged out successfully', 'success');
                }).catch(error => {
                    showToast('Error logging out: ' + error.message, 'error');
                });
            });
            
            // Navigation links
            navLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const section = link.getAttribute('data-section');
                    showSection(section);
                    
                    // Update active state
                    navLinks.forEach(navLink => {
                        navLink.classList.remove('active');
                    });
                    link.classList.add('active');
                });
            });
            
            // QR Generator form
            qrGeneratorForm.addEventListener('submit', e => {
                e.preventDefault();
                generateQRCode();
            });
            
            // QR Size slider
            document.getElementById('qr-size').addEventListener('input', function() {
                document.getElementById('qr-size-value').textContent = this.value + 'px';
            });
            
            // Download QR button
            downloadQrBtn.addEventListener('click', downloadQRCode);
            
            // Save QR button
            saveQrBtn.addEventListener('click', saveQRCode);
            
            // Refresh buttons
            refreshQrListBtn.addEventListener('click', loadUserQRs);
            refreshUsersBtn.addEventListener('click', loadAllUsers);
        }
        
        // Show login page
        function showLogin() {
            loginPage.classList.remove('hidden');
            registerPage.classList.add('hidden');
            appContainer.classList.add('hidden');
        }
        
        // Show app
        function showApp() {
            loginPage.classList.add('hidden');
            registerPage.classList.add('hidden');
            appContainer.classList.remove('hidden');
            
            // Show dashboard by default
            showSection('dashboard');
            
            // Load initial data
            loadDashboardData();
            loadUserQRs();
        }
        
        // Show specific section
        function showSection(sectionId) {
            contentSections.forEach(section => {
                section.classList.add('hidden');
            });
            
            document.getElementById(`${sectionId}-section`).classList.remove('hidden');
            
            // Load section-specific data
            switch(sectionId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'my-qrcodes':
                    loadUserQRs();
                    break;
                case 'users':
                    loadAllUsers();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
            }
        }
        
        // Login user
        function loginUser(email, password) {
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // Record login activity
                    recordUserActivity('login');
                    
                    // Get user IP and location
                    getUserIP().then(ipData => {
                        updateUserLoginInfo(ipData);
                    });
                    
                    showToast('Logged in successfully', 'success');
                })
                .catch(error => {
                    showToast('Login error: ' + error.message, 'error');
                });
        }
        
        // Register new user
        function registerUser(name, email, password) {
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // Save additional user data
                    return db.collection('users').doc(userCredential.user.uid).set({
                        name: name,
                        email: email,
                        role: 'user',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                        ip: '',
                        location: '',
                        device: navigator.userAgent
                    });
                })
                .then(() => {
                    // Record registration activity
                    recordUserActivity('register');
                    
                    // Get user IP and location
                    getUserIP().then(ipData => {
                        updateUserLoginInfo(ipData);
                    });
                    
                    showToast('Registration successful!', 'success');
                    registerPage.classList.add('hidden');
                    loginPage.classList.remove('hidden');
                    loginForm.reset();
                })
                .catch(error => {
                    showToast('Registration error: ' + error.message, 'error');
                });
        }
        
        // Load user data
        function loadUserData() {
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        userName.textContent = userData.name;
                        userAvatar.textContent = userData.name.charAt(0).toUpperCase();
                        
                        // Set avatar color based on name
                        const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6'];
                        const colorIndex = userData.name.length % colors.length;
                        userAvatar.style.backgroundColor = colors[colorIndex];
                    }
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                });
        }
        
        // Check if user is admin
        function checkAdminStatus() {
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists && doc.data().role === 'admin') {
                        adminOnlyElements.forEach(element => {
                            element.classList.remove('hidden');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error checking admin status:', error);
                });
        }
        
        // Generate QR code
        function generateQRCode() {
            const content = document.getElementById('qr-content').value;
            const color = document.getElementById('qr-color').value;
            const bgColor = document.getElementById('qr-bg-color').value;
            const size = document.getElementById('qr-size').value;
            const errorCorrection = document.getElementById('qr-error-correction').value;
            
            // Clear previous QR code
            qrcodeDiv.innerHTML = '';
            
            // Generate new QR code
            currentQRCode = new QRCode(qrcodeDiv, {
                text: content,
                width: parseInt(size),
                height: parseInt(size),
                colorDark: color,
                colorLight: bgColor,
                correctLevel: QRCode.CorrectLevel[errorCorrection]
            });
            
            // Show result section
            qrResult.classList.remove('hidden');
            
            // Set default filename
            const now = new Date();
            qrFilename.value = `qrcode_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // Download QR code
        function downloadQRCode() {
            const canvas = qrcodeDiv.querySelector('canvas');
            if (!canvas) {
                showToast('No QR code to download', 'error');
                return;
            }
            
            const link = document.createElement('a');
            link.download = qrFilename.value + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
        
        // Save QR code to database
        function saveQRCode() {
            const canvas = qrcodeDiv.querySelector('canvas');
            if (!canvas) {
                showToast('No QR code to save', 'error');
                return;
            }
            
            const content = document.getElementById('qr-content').value;
            const filename = qrFilename.value || 'untitled';
            const imageData = canvas.toDataURL('image/png');
            
            db.collection('qrcodes').add({
                userId: currentUser.uid,
                content: content,
                imageData: imageData,
                filename: filename,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                scans: 0,
                color: document.getElementById('qr-color').value,
                bgColor: document.getElementById('qr-bg-color').value,
                size: document.getElementById('qr-size').value,
                errorCorrection: document.getElementById('qr-error-correction').value
            })
            .then(() => {
                showToast('QR code saved successfully', 'success');
                loadUserQRs();
            })
            .catch(error => {
                showToast('Error saving QR code: ' + error.message, 'error');
            });
        }
        
        // Load user's QR codes
        function loadUserQRs() {
            myQrTable.innerHTML = '<tr><td colspan="5" class="text-center"><div class="loading-spinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div></td></tr>';
            
            db.collection('qrcodes')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get()
                .then(querySnapshot => {
                    myQrTable.innerHTML = '';
                    userQRs = [];
                    
                    if (querySnapshot.empty) {
                        myQrTable.innerHTML = '<tr><td colspan="5" class="text-center">No QR codes found</td></tr>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const qrData = doc.data();
                        qrData.id = doc.id;
                        userQRs.push(qrData);
                        
                        const row = myQrTable.insertRow();
                        const dateCell = row.insertCell(0);
                        const nameCell = row.insertCell(1);
                        const contentCell = row.insertCell(2);
                        const scansCell = row.insertCell(3);
                        const actionsCell = row.insertCell(4);
                        
                        // Format date
                        const date = qrData.createdAt.toDate();
                        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                        
                        dateCell.textContent = formattedDate;
                        nameCell.textContent = qrData.filename;
                        contentCell.textContent = qrData.content.length > 50 ? qrData.content.substring(0, 50) + '...' : qrData.content;
                        scansCell.textContent = qrData.scans;
                        
                        // Actions
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'btn btn-sm btn-primary me-2';
                        downloadBtn.innerHTML = '<i class="fas fa-download"></i>';
                        downloadBtn.title = 'Download';
                        downloadBtn.addEventListener('click', () => downloadSavedQR(qrData.id));
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-sm btn-danger';
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        deleteBtn.title = 'Delete';
                        deleteBtn.addEventListener('click', () => deleteQRCode(qrData.id));
                        
                        actionsCell.appendChild(downloadBtn);
                        actionsCell.appendChild(deleteBtn);
                    });
                })
                .catch(error => {
                    myQrTable.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading QR codes</td></tr>';
                    console.error('Error loading QR codes:', error);
                });
        }
        
        // Download saved QR code
        function downloadSavedQR(qrId) {
            const qr = userQRs.find(q => q.id === qrId);
            if (!qr) return;
            
            const link = document.createElement('a');
            link.download = qr.filename + '.png';
            link.href = qr.imageData;
            link.click();
        }
        
        // Delete QR code
        function deleteQRCode(qrId) {
            if (confirm('Are you sure you want to delete this QR code?')) {
                db.collection('qrcodes').doc(qrId).delete()
                    .then(() => {
                        showToast('QR code deleted successfully', 'success');
                        loadUserQRs();
                    })
                    .catch(error => {
                        showToast('Error deleting QR code: ' + error.message, 'error');
                    });
            }
        }
        
        // Load all users (admin only)
        function loadAllUsers() {
            usersTable.innerHTML = '<tr><td colspan="8" class="text-center"><div class="loading-spinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div></td></tr>';
            
            db.collection('users').orderBy('createdAt', 'desc').get()
                .then(querySnapshot => {
                    usersTable.innerHTML = '';
                    allUsers = [];
                    
                    if (querySnapshot.empty) {
                        usersTable.innerHTML = '<tr><td colspan="8" class="text-center">No users found</td></tr>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const userData = doc.data();
                        userData.id = doc.id;
                        allUsers.push(userData);
                        
                        const row = usersTable.insertRow();
                        const idCell = row.insertCell(0);
                        const nameCell = row.insertCell(1);
                        const emailCell = row.insertCell(2);
                        const roleCell = row.insertCell(3);
                        const registeredCell = row.insertCell(4);
                        const lastLoginCell = row.insertCell(5);
                        const ipCell = row.insertCell(6);
                        const actionsCell = row.insertCell(7);
                        
                        idCell.textContent = userData.id.substring(0, 8) + '...';
                        nameCell.textContent = userData.name;
                        emailCell.textContent = userData.email;
                        roleCell.textContent = userData.role || 'user';
                        
                        // Format dates
                        if (userData.createdAt) {
                            const regDate = userData.createdAt.toDate();
                            registeredCell.textContent = regDate.toLocaleDateString();
                        } else {
                            registeredCell.textContent = 'N/A';
                        }
                        
                        if (userData.lastLogin) {
                            const loginDate = userData.lastLogin.toDate();
                            lastLoginCell.textContent = loginDate.toLocaleDateString();
                        } else {
                            lastLoginCell.textContent = 'N/A';
                        }
                        
                        ipCell.textContent = userData.ip || 'N/A';
                        
                        // Actions
                        if (userData.role !== 'admin') {
                            const makeAdminBtn = document.createElement('button');
                            makeAdminBtn.className = 'btn btn-sm btn-success me-2';
                            makeAdminBtn.textContent = 'Make Admin';
                            makeAdminBtn.addEventListener('click', () => makeAdmin(userData.id));
                            
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'btn btn-sm btn-danger';
                            deleteBtn.textContent = 'Delete';
                            deleteBtn.addEventListener('click', () => deleteUser(userData.id));
                            
                            actionsCell.appendChild(makeAdminBtn);
                            actionsCell.appendChild(deleteBtn);
                        } else {
                            actionsCell.textContent = 'Admin';
                        }
                    });
                })
                .catch(error => {
                    usersTable.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading users</td></tr>';
                    console.error('Error loading users:', error);
                });
        }
        
        // Make user admin
        function makeAdmin(userId) {
            if (confirm('Are you sure you want to make this user an admin?')) {
                db.collection('users').doc(userId).update({
                    role: 'admin'
                })
                .then(() => {
                    showToast('User promoted to admin', 'success');
                    loadAllUsers();
                })
                .catch(error => {
                    showToast('Error making user admin: ' + error.message, 'error');
                });
            }
        }
        
        // Delete user
        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This cannot be undone.')) {
                // First delete all their QR codes
                db.collection('qrcodes').where('userId', '==', userId).get()
                    .then(querySnapshot => {
                        const batch = db.batch();
                        querySnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        return batch.commit();
                    })
                    .then(() => {
                        // Then delete the user
                        return db.collection('users').doc(userId).delete();
                    })
                    .then(() => {
                        showToast('User deleted successfully', 'success');
                        loadAllUsers();
                    })
                    .catch(error => {
                        showToast('Error deleting user: ' + error.message, 'error');
                    });
            }
        }
        
        // Load dashboard data
        function loadDashboardData() {
            // Total QR codes
            db.collection('qrcodes').count().get()
                .then(snap => {
                    totalQrGenerated.textContent = snap.data().count.toLocaleString();
                });
            
            // Total users
            db.collection('users').count().get()
                .then(snap => {
                    totalUsers.textContent = snap.data().count.toLocaleString();
                });
            
            // Total scans (sum of all scans)
            db.collection('qrcodes').get()
                .then(querySnapshot => {
                    let total = 0;
                    querySnapshot.forEach(doc => {
                        total += doc.data().scans || 0;
                    });
                    totalScans.textContent = total.toLocaleString();
                });
            
            // Recent QR codes
            const recentQrTable = document.getElementById('recent-qr-table').getElementsByTagName('tbody')[0];
            recentQrTable.innerHTML = '<tr><td colspan="3" class="text-center"><div class="loading-spinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div></td></tr>';
            
            db.collection('qrcodes')
                .orderBy('createdAt', 'desc')
                .limit(5)
                .get()
                .then(querySnapshot => {
                    recentQrTable.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        recentQrTable.innerHTML = '<tr><td colspan="3" class="text-center">No QR codes found</td></tr>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const qrData = doc.data();
                        const row = recentQrTable.insertRow();
                        const dateCell = row.insertCell(0);
                        const contentCell = row.insertCell(1);
                        const scansCell = row.insertCell(2);
                        
                        // Format date
                        const date = qrData.createdAt.toDate();
                        const formattedDate = date.toLocaleDateString();
                        
                        dateCell.textContent = formattedDate;
                        contentCell.textContent = qrData.content.length > 30 ? qrData.content.substring(0, 30) + '...' : qrData.content;
                        scansCell.textContent = qrData.scans;
                    });
                });
            
            // Recent user activity
            const userActivityTable = document.getElementById('user-activity-table').getElementsByTagName('tbody')[0];
            userActivityTable.innerHTML = '<tr><td colspan="3" class="text-center"><div class="loading-spinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div></td></tr>';
            
            db.collection('user_activity')
                .orderBy('timestamp', 'desc')
                .limit(5)
                .get()
                .then(querySnapshot => {
                    userActivityTable.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        userActivityTable.innerHTML = '<tr><td colspan="3" class="text-center">No activity found</td></tr>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const activity = doc.data();
                        const row = userActivityTable.insertRow();
                        const userCell = row.insertCell(0);
                        const actionCell = row.insertCell(1);
                        const timeCell = row.insertCell(2);
                        
                        // Get user name
                        db.collection('users').doc(activity.userId).get()
                            .then(userDoc => {
                                if (userDoc.exists) {
                                    userCell.textContent = userDoc.data().name;
                                } else {
                                    userCell.textContent = 'Unknown User';
                                }
                            });
                        
                        actionCell.textContent = activity.action;
                        
                        // Format time
                        const time = activity.timestamp.toDate();
                        const formattedTime = time.toLocaleTimeString();
                        
                        timeCell.textContent = formattedTime;
                    });
                });
        }
        
        // Load analytics data
        function loadAnalytics() {
            // QR Usage Chart
            const qrUsageCtx = document.getElementById('qr-usage-chart').getContext('2d');
            
            // Get data for last 7 days
            const dates = [];
            const counts = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toLocaleDateString());
                
                // Count QR codes created on this day
                const start = new Date(date);
                start.setHours(0, 0, 0, 0);
                const end = new Date(date);
                end.setHours(23, 59, 59, 999);
                
                db.collection('qrcodes')
                    .where('createdAt', '>=', start)
                    .where('createdAt', '<=', end)
                    .count().get()
                    .then(snap => {
                        counts.push(snap.data().count);
                        
                        // If we have all data, create chart
                        if (counts.length === 7) {
                            new Chart(qrUsageCtx, {
                                type: 'bar',
                                data: {
                                    labels: dates,
                                    datasets: [{
                                        label: 'QR Codes Generated',
                                        data: counts,
                                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                                        borderColor: 'rgba(52, 152, 219, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    scales: {
                                        y: {
                                            beginAtZero: true
                                        }
                                    }
                                }
                            });
                        }
                    });
            }
            
            // User Activity Chart
            const userActivityCtx = document.getElementById('user-activity-chart').getContext('2d');
            
            // Count different types of activities
            const activityTypes = ['login', 'register', 'qr_generated', 'qr_deleted'];
            const activityCounts = [];
            
            activityTypes.forEach(type => {
                db.collection('user_activity')
                    .where('action', '==', type)
                    .count().get()
                    .then(snap => {
                        activityCounts.push(snap.data().count);
                        
                        // If we have all data, create chart
                        if (activityCounts.length === activityTypes.length) {
                            new Chart(userActivityCtx, {
                                type: 'doughnut',
                                data: {
                                    labels: activityTypes.map(t => t.replace('_', ' ')),
                                    datasets: [{
                                        data: activityCounts,
                                        backgroundColor: [
                                            'rgba(52, 152, 219, 0.7)',
                                            'rgba(46, 204, 113, 0.7)',
                                            'rgba(155, 89, 182, 0.7)',
                                            'rgba(231, 76, 60, 0.7)'
                                        ],
                                        borderColor: [
                                            'rgba(52, 152, 219, 1)',
                                            'rgba(46, 204, 113, 1)',
                                            'rgba(155, 89, 182, 1)',
                                            'rgba(231, 76, 60, 1)'
                                        ],
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true
                                }
                            });
                        }
                    });
            });
            
            // User Locations Map (placeholder)
            // In a real app, you would integrate with Google Maps or similar API
            const mapContainer = document.getElementById('user-locations-map');
            mapContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="text-center"><i class="fas fa-map-marker-alt fa-3x text-primary mb-3"></i><h4>User Locations Map</h4><p class="text-muted">Map integration would show user locations here</p></div></div>';
        }
        
        // Get user IP and location
        function getUserIP() {
            return fetch('https://ipapi.co/json/')
                .then(response => response.json())
                .then(data => {
                    return {
                        ip: data.ip,
                        city: data.city,
                        region: data.region,
                        country: data.country_name,
                        isp: data.org
                    };
                })
                .catch(() => {
                    return {
                        ip: 'Unknown',
                        city: 'Unknown',
                        region: 'Unknown',
                        country: 'Unknown',
                        isp: 'Unknown'
                    };
                });
        }
        
        // Update user login info with IP and location
        function updateUserLoginInfo(ipData) {
            db.collection('users').doc(currentUser.uid).update({
                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                ip: ipData.ip,
                location: `${ipData.city}, ${ipData.region}, ${ipData.country}`,
                isp: ipData.isp,
                device: navigator.userAgent
            }).catch(error => {
                console.error('Error updating user login info:', error);
            });
        }
        
        // Record user activity
        function recordUserActivity(action) {
            if (!currentUser) return;
            
            db.collection('user_activity').add({
                userId: currentUser.uid,
                action: action,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                ip: '', // Will be updated by getUserIP
                device: navigator.userAgent
            }).then(() => {
                // Update with IP info
                getUserIP().then(ipData => {
                    db.collection('user_activity')
                        .where('userId', '==', currentUser.uid)
                        .orderBy('timestamp', 'desc')
                        .limit(1)
                        .get()
                        .then(querySnapshot => {
                            if (!querySnapshot.empty) {
                                querySnapshot.forEach(doc => {
                                    db.collection('user_activity').doc(doc.id).update({
                                        ip: ipData.ip,
                                        location: `${ipData.city}, ${ipData.region}, ${ipData.country}`
                                    });
                                });
                            }
                        });
                });
            }).catch(error => {
                console.error('Error recording user activity:', error);
            });
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast show align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            const toastBody = document.createElement('div');
            toastBody.className = 'd-flex';
            
            const toastMessage = document.createElement('div');
            toastMessage.className = 'toast-body';
            toastMessage.textContent = message;
            
            const closeButton = document.createElement('button');
            closeButton.type = 'button';
            closeButton.className = 'btn-close btn-close-white me-2 m-auto';
            closeButton.setAttribute('data-bs-dismiss', 'toast');
            closeButton.setAttribute('aria-label', 'Close');
            
            toastBody.appendChild(toastMessage);
            toastBody.appendChild(closeButton);
            toast.appendChild(toastBody);
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
