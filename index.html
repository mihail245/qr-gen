<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Продвинутый инструмент для работы с QR-кодами</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"], 
        input[type="url"], 
        input[type="tel"], 
        input[type="email"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .qr-result {
            margin-top: 20px;
            text-align: center;
        }
        
        #qrCodeImage {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: white;
        }
        
        .download-btn {
            margin-top: 15px;
            background-color: #27ae60;
        }
        
        .download-btn:hover {
            background-color: #219653;
        }
        
        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        #scanner {
            width: 100%;
            height: auto;
            border: 1px solid #ddd;
        }
        
        #scanResult {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
        
        .error {
            color: #e74c3c;
            margin-top: 10px;
        }
        
        .success {
            color: #27ae60;
            margin-top: 10px;
        }
        
        .qr-types {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .qr-type {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background-color: white;
        }
        
        @media (max-width: 768px) {
            .qr-types {
                grid-template-columns: 1fr;
            }
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Продвинутый инструмент для работы с QR-кодами</h1>
        
        <div class="tabs">
            <div class="tab active" data-tab="generator">Генератор</div>
            <div class="tab" data-tab="scanner">Сканер</div>
            <div class="tab" data-tab="history">История</div>
        </div>
        
        <!-- Генератор QR-кодов -->
        <div id="generator" class="tab-content active">
            <div class="section">
                <h2 class="section-title">Тип QR-кода</h2>
                <select id="qrType">
                    <option value="text">Текст</option>
                    <option value="url">URL-адрес</option>
                    <option value="email">Электронная почта</option>
                    <option value="phone">Телефон</option>
                    <option value="sms">SMS</option>
                    <option value="geo">Геолокация</option>
                    <option value="wifi">Wi-Fi</option>
                    <option value="vcard">Контакт (vCard)</option>
                    <option value="event">Событие</option>
                    <option value="crypto">Криптовалюта</option>
                </select>
            </div>
            
            <div class="qr-types">
                <!-- Текстовый QR-код -->
                <div id="textType" class="qr-type">
                    <h3>Текст</h3>
                    <div class="input-group">
                        <label for="textContent">Текст для кодирования:</label>
                        <textarea id="textContent" placeholder="Введите любой текст"></textarea>
                    </div>
                    <button id="generateText">Сгенерировать QR-код</button>
                </div>
                
                <!-- URL QR-код -->
                <div id="urlType" class="qr-type" style="display:none;">
                    <h3>URL-адрес</h3>
                    <div class="input-group">
                        <label for="urlContent">Введите URL:</label>
                        <input type="url" id="urlContent" placeholder="https://example.com">
                    </div>
                    <button id="generateUrl">Сгенерировать QR-код</button>
                </div>
                
                <!-- Email QR-код -->
                <div id="emailType" class="qr-type" style="display:none;">
                    <h3>Электронная почта</h3>
                    <div class="input-group">
                        <label for="emailAddress">Email адрес:</label>
                        <input type="email" id="emailAddress" placeholder="user@example.com">
                    </div>
                    <div class="input-group">
                        <label for="emailSubject">Тема (необязательно):</label>
                        <input type="text" id="emailSubject" placeholder="Тема письма">
                    </div>
                    <div class="input-group">
                        <label for="emailBody">Текст письма (необязательно):</label>
                        <textarea id="emailBody" placeholder="Текст письма"></textarea>
                    </div>
                    <button id="generateEmail">Сгенерировать QR-код</button>
                </div>
                
                <!-- Телефонный QR-код -->
                <div id="phoneType" class="qr-type" style="display:none;">
                    <h3>Телефон</h3>
                    <div class="input-group">
                        <label for="phoneNumber">Номер телефона:</label>
                        <input type="tel" id="phoneNumber" placeholder="+71234567890">
                    </div>
                    <button id="generatePhone">Сгенерировать QR-код</button>
                </div>
                
                <!-- SMS QR-код -->
                <div id="smsType" class="qr-type" style="display:none;">
                    <h3>SMS</h3>
                    <div class="input-group">
                        <label for="smsNumber">Номер телефона:</label>
                        <input type="tel" id="smsNumber" placeholder="+71234567890">
                    </div>
                    <div class="input-group">
                        <label for="smsMessage">Текст сообщения:</label>
                        <textarea id="smsMessage" placeholder="Текст SMS"></textarea>
                    </div>
                    <button id="generateSms">Сгенерировать QR-код</button>
                </div>
                
                <!-- Геолокационный QR-код -->
                <div id="geoType" class="qr-type" style="display:none;">
                    <h3>Геолокация</h3>
                    <div class="input-group">
                        <label for="geoLatitude">Широта:</label>
                        <input type="text" id="geoLatitude" placeholder="55.7558">
                    </div>
                    <div class="input-group">
                        <label for="geoLongitude">Долгота:</label>
                        <input type="text" id="geoLongitude" placeholder="37.6173">
                    </div>
                    <div class="input-group">
                        <label for="geoLabel">Метка (необязательно):</label>
                        <input type="text" id="geoLabel" placeholder="Москва, Красная площадь">
                    </div>
                    <button id="generateGeo">Сгенерировать QR-код</button>
                </div>
                
                <!-- Wi-Fi QR-код -->
                <div id="wifiType" class="qr-type" style="display:none;">
                    <h3>Wi-Fi</h3>
                    <div class="input-group">
                        <label for="wifiSsid">Имя сети (SSID):</label>
                        <input type="text" id="wifiSsid" placeholder="Имя Wi-Fi сети">
                    </div>
                    <div class="input-group">
                        <label for="wifiPassword">Пароль:</label>
                        <input type="text" id="wifiPassword" placeholder="Пароль Wi-Fi">
                    </div>
                    <div class="input-group">
                        <label for="wifiEncryption">Тип шифрования:</label>
                        <select id="wifiEncryption">
                            <option value="WPA">WPA/WPA2</option>
                            <option value="WEP">WEP</option>
                            <option value="nopass">Без пароля</option>
                        </select>
                    </div>
                    <button id="generateWifi">Сгенерировать QR-код</button>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title">Настройки QR-кода</h2>
                <div class="input-group">
                    <label for="qrSize">Размер (пикселей):</label>
                    <input type="number" id="qrSize" value="200" min="100" max="1000">
                </div>
                <div class="input-group">
                    <label for="qrColor">Цвет:</label>
                    <input type="color" id="qrColor" value="#000000">
                </div>
                <div class="input-group">
                    <label for="qrBgColor">Цвет фона:</label>
                    <input type="color" id="qrBgColor" value="#ffffff">
                </div>
                <div class="input-group">
                    <label for="qrErrorCorrection">Уровень коррекции ошибок:</label>
                    <select id="qrErrorCorrection">
                        <option value="L">Низкий (7%)</option>
                        <option value="M" selected>Средний (15%)</option>
                        <option value="Q">Высокий (25%)</option>
                        <option value="H">Максимальный (30%)</option>
                    </select>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title">Результат</h2>
                <div class="qr-result">
                    <canvas id="qrCodeCanvas" style="display:none;"></canvas>
                    <img id="qrCodeImage" src="" alt="QR Code" style="display:none;">
                    <div id="qrError" class="error"></div>
                </div>
                <button id="downloadQr" class="download-btn" style="display:none;">Скачать QR-код</button>
            </div>
        </div>
        
        <!-- Сканер QR-кодов -->
        <div id="scanner" class="tab-content">
            <div class="section">
                <h2 class="section-title">Сканирование QR-кода</h2>
                <div class="scanner-container">
                    <video id="scanner" playsinline></video>
                </div>
                <button id="startScanner">Начать сканирование</button>
                <button id="stopScanner" style="display:none;">Остановить сканирование</button>
                <div id="scanResult"></div>
            </div>
            
            <div class="section">
                <h2 class="section-title">Загрузка изображения</h2>
                <div class="input-group">
                    <label for="fileInput">Выберите изображение с QR-кодом:</label>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                <div id="fileScanResult"></div>
            </div>
        </div>
        
        <!-- История -->
        <div id="history" class="tab-content">
            <div class="section">
                <h2 class="section-title">История генерации</h2>
                <div id="generationHistory"></div>
            </div>
            
            <div class="section">
                <h2 class="section-title">История сканирования</h2>
                <div id="scanHistory"></div>
            </div>
        </div>
    </div>

    <script>
        // Глобальные переменные
        let currentTab = 'generator';
        let qrHistory = JSON.parse(localStorage.getItem('qrHistory')) || [];
        let scanHistory = JSON.parse(localStorage.getItem('scanHistory')) || [];
        let stream = null;
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            initTabs();
            initQrTypeSwitcher();
            initGenerators();
            initScanner();
            loadHistory();
            
            // Показать текстовый тип QR-кода по умолчанию
            showQrType('text');
        });
        
        // Инициализация вкладок
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Убрать активный класс со всех вкладок
                    tabs.forEach(t => t.classList.remove('active'));
                    // Добавить активный класс текущей вкладке
                    this.classList.add('active');
                    
                    // Скрыть все содержимое вкладок
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Показать содержимое текущей вкладки
                    currentTab = this.dataset.tab;
                    document.getElementById(currentTab).classList.add('active');
                    
                    // Остановить сканер при переключении с вкладки сканера
                    if (currentTab !== 'scanner' && stream) {
                        stopScanner();
                    }
                });
            });
        }
        
        // Инициализация переключателя типов QR-кодов
        function initQrTypeSwitcher() {
            const qrTypeSelect = document.getElementById('qrType');
            qrTypeSelect.addEventListener('change', function() {
                showQrType(this.value);
            });
        }
        
        // Показать соответствующий тип QR-кода
        function showQrType(type) {
            // Скрыть все типы
            document.querySelectorAll('.qr-type').forEach(el => {
                el.style.display = 'none';
            });
            
            // Показать выбранный тип
            document.getElementById(`${type}Type`).style.display = 'block';
        }
        
        // Инициализация генераторов QR-кодов
        function initGenerators() {
            // Текстовый QR-код
            document.getElementById('generateText').addEventListener('click', generateTextQr);
            
            // URL QR-код
            document.getElementById('generateUrl').addEventListener('click', generateUrlQr);
            
            // Email QR-код
            document.getElementById('generateEmail').addEventListener('click', generateEmailQr);
            
            // Телефонный QR-код
            document.getElementById('generatePhone').addEventListener('click', generatePhoneQr);
            
            // SMS QR-код
            document.getElementById('generateSms').addEventListener('click', generateSmsQr);
            
            // Геолокационный QR-код
            document.getElementById('generateGeo').addEventListener('click', generateGeoQr);
            
            // Wi-Fi QR-код
            document.getElementById('generateWifi').addEventListener('click', generateWifiQr);
            
            // Кнопка скачивания
            document.getElementById('downloadQr').addEventListener('click', downloadQr);
        }
        
        // Генерация текстового QR-кода
        function generateTextQr() {
            const text = document.getElementById('textContent').value.trim();
            if (!text) {
                showError('Пожалуйста, введите текст для кодирования');
                return;
            }
            
            generateQrCode(text, 'Текст');
        }
        
        // Генерация URL QR-кода
        function generateUrlQr() {
            let url = document.getElementById('urlContent').value.trim();
            if (!url) {
                showError('Пожалуйста, введите URL-адрес');
                return;
            }
            
            // Добавить протокол, если отсутствует
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            
            generateQrCode(url, 'URL');
        }
        
        // Генерация Email QR-кода
        function generateEmailQr() {
            const email = document.getElementById('emailAddress').value.trim();
            if (!email) {
                showError('Пожалуйста, введите email адрес');
                return;
            }
            
            const subject = document.getElementById('emailSubject').value.trim();
            const body = document.getElementById('emailBody').value.trim();
            
            let qrContent = `mailto:${email}`;
            const params = [];
            
            if (subject) params.push(`subject=${encodeURIComponent(subject)}`);
            if (body) params.push(`body=${encodeURIComponent(body)}`);
            
            if (params.length > 0) {
                qrContent += `?${params.join('&')}`;
            }
            
            generateQrCode(qrContent, 'Email');
        }
        
        // Генерация телефонного QR-кода
        function generatePhoneQr() {
            let phone = document.getElementById('phoneNumber').value.trim();
            if (!phone) {
                showError('Пожалуйста, введите номер телефона');
                return;
            }
            
            // Удалить все нецифровые символы, кроме плюса
            phone = phone.replace(/[^\d+]/g, '');
            
            generateQrCode(`tel:${phone}`, 'Телефон');
        }
        
        // Генерация SMS QR-кода
        function generateSmsQr() {
            let phone = document.getElementById('smsNumber').value.trim();
            if (!phone) {
                showError('Пожалуйста, введите номер телефона');
                return;
            }
            
            // Удалить все нецифровые символы, кроме плюса
            phone = phone.replace(/[^\d+]/g, '');
            
            const message = document.getElementById('smsMessage').value.trim();
            let qrContent = `sms:${phone}`;
            
            if (message) {
                qrContent += `?body=${encodeURIComponent(message)}`;
            }
            
            generateQrCode(qrContent, 'SMS');
        }
        
        // Генерация геолокационного QR-кода
        function generateGeoQr() {
            const latitude = document.getElementById('geoLatitude').value.trim();
            const longitude = document.getElementById('geoLongitude').value.trim();
            
            if (!latitude || !longitude) {
                showError('Пожалуйста, введите широту и долготу');
                return;
            }
            
            const label = document.getElementById('geoLabel').value.trim();
            let qrContent = `geo:${latitude},${longitude}`;
            
            if (label) {
                qrContent += `?q=${encodeURIComponent(label)}`;
            }
            
            generateQrCode(qrContent, 'Геолокация');
        }
        
        // Генерация Wi-Fi QR-кода
        function generateWifiQr() {
            const ssid = document.getElementById('wifiSsid').value.trim();
            if (!ssid) {
                showError('Пожалуйста, введите имя Wi-Fi сети');
                return;
            }
            
            const password = document.getElementById('wifiPassword').value.trim();
            const encryption = document.getElementById('wifiEncryption').value;
            
            let qrContent = `WIFI:T:${encryption};S:${ssid};`;
            
            if (password && encryption !== 'nopass') {
                qrContent += `P:${password};`;
            }
            
            qrContent += ';';
            
            generateQrCode(qrContent, 'Wi-Fi');
        }
        
        // Общая функция генерации QR-кода
        function generateQrCode(content, type) {
            const size = parseInt(document.getElementById('qrSize').value);
            const color = document.getElementById('qrColor').value;
            const bgColor = document.getElementById('qrBgColor').value;
            const errorCorrection = document.getElementById('qrErrorCorrection').value;
            
            const canvas = document.getElementById('qrCodeCanvas');
            canvas.width = size;
            canvas.height = size;
            
            QRCode.toCanvas(canvas, content, {
                width: size,
                color: {
                    dark: color,
                    light: bgColor
                },
                errorCorrectionLevel: errorCorrection
            }, function(error) {
                if (error) {
                    showError('Ошибка при генерации QR-кода: ' + error.message);
                    return;
                }
                
                // Преобразовать canvas в изображение
                const qrImage = document.getElementById('qrCodeImage');
                qrImage.src = canvas.toDataURL('image/png');
                qrImage.style.display = 'block';
                
                // Показать кнопку скачивания
                document.getElementById('downloadQr').style.display = 'inline-block';
                
                // Очистить сообщение об ошибке
                document.getElementById('qrError').textContent = '';
                
                // Добавить в историю
                addToHistory({
                    type: type,
                    content: content,
                    timestamp: new Date().toISOString(),
                    image: qrImage.src
                });
            });
        }
        
        // Скачивание QR-кода
        function downloadQr() {
            const qrImage = document.getElementById('qrCodeImage');
            if (!qrImage.src) return;
            
            const link = document.createElement('a');
            link.href = qrImage.src;
            link.download = 'qr-code.png';
            link.click();
        }
        
        // Показать ошибку
        function showError(message) {
            const errorEl = document.getElementById('qrError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            
            // Скрыть QR-код и кнопку скачивания
            document.getElementById('qrCodeImage').style.display = 'none';
            document.getElementById('downloadQr').style.display = 'none';
        }
        
        // Инициализация сканера
        function initScanner() {
            document.getElementById('startScanner').addEventListener('click', startScanner);
            document.getElementById('stopScanner').addEventListener('click', stopScanner);
            document.getElementById('fileInput').addEventListener('change', scanFile);
        }
        
        // Запуск сканера
        function startScanner() {
            const video = document.getElementById('scanner');
            const startBtn = document.getElementById('startScanner');
            const stopBtn = document.getElementById('stopScanner');
            const resultEl = document.getElementById('scanResult');
            
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            resultEl.textContent = 'Сканирование...';
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(function(mediaStream) {
                    stream = mediaStream;
                    video.srcObject = stream;
                    video.setAttribute('playsinline', true);
                    video.play();
                    
                    requestAnimationFrame(tick);
                })
                .catch(function(err) {
                    console.error('Ошибка доступа к камере:', err);
                    resultEl.textContent = 'Ошибка: ' + err.message;
                    startBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                });
        }
        
        // Остановка сканера
        function stopScanner() {
            const video = document.getElementById('scanner');
            const startBtn = document.getElementById('startScanner');
            const stopBtn = document.getElementById('stopScanner');
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            video.srcObject = null;
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
        }
        
        // Функция сканирования кадров
        function tick() {
            const video = document.getElementById('scanner');
            const resultEl = document.getElementById('scanResult');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: 'dontInvert',
                });
                
                if (code) {
                    resultEl.innerHTML = `
                        <strong>Тип:</strong> ${detectQrType(code.data)}<br>
                        <strong>Содержимое:</strong> ${code.data}<br>
                        <button class="copy-btn" data-text="${escapeHtml(code.data)}">Копировать</button>
                    `;
                    
                    // Добавить обработчик кнопки копирования
                    document.querySelector('.copy-btn').addEventListener('click', function() {
                        navigator.clipboard.writeText(this.dataset.text)
                            .then(() => alert('Скопировано в буфер обмена'))
                            .catch(err => console.error('Ошибка копирования:', err));
                    });
                    
                    // Добавить в историю сканирования
                    addToScanHistory({
                        content: code.data,
                        type: detectQrType(code.data),
                        timestamp: new Date().toISOString()
                    });
                    
                    // Остановить сканер после успешного сканирования
                    stopScanner();
                    return;
                }
            }
            
            requestAnimationFrame(tick);
        }
        
        // Сканирование QR-кода из файла
        function scanFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const resultEl = document.getElementById('fileScanResult');
            resultEl.textContent = 'Обработка изображения...';
            
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: 'dontInvert',
                });
                
                if (code) {
                    resultEl.innerHTML = `
                        <strong>Тип:</strong> ${detectQrType(code.data)}<br>
                        <strong>Содержимое:</strong> ${code.data}<br>
                        <button class="copy-btn" data-text="${escapeHtml(code.data)}">Копировать</button>
                    `;
                    
                    // Добавить обработчик кнопки копирования
                    document.querySelector('.copy-btn').addEventListener('click', function() {
                        navigator.clipboard.writeText(this.dataset.text)
                            .then(() => alert('Скопировано в буфер обмена'))
                            .catch(err => console.error('Ошибка копирования:', err));
                    });
                    
                    // Добавить в историю сканирования
                    addToScanHistory({
                        content: code.data,
                        type: detectQrType(code.data),
                        timestamp: new Date().toISOString()
                    });
                } else {
                    resultEl.textContent = 'QR-код не найден на изображении';
                }
            };
            
            img.onerror = function() {
                resultEl.textContent = 'Ошибка загрузки изображения';
            };
            
            const reader = new FileReader();
            reader.onload = function(e) {
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Определение типа QR-кода
        function detectQrType(data) {
            if (data.startsWith('http://') || data.startsWith('https://')) {
                return 'URL';
            } else if (data.startsWith('mailto:')) {
                return 'Email';
            } else if (data.startsWith('tel:')) {
                return 'Телефон';
            } else if (data.startsWith('sms:')) {
                return 'SMS';
            } else if (data.startsWith('geo:')) {
                return 'Геолокация';
            } else if (data.startsWith('WIFI:')) {
                return 'Wi-Fi';
            } else if (data.startsWith('BEGIN:VCARD')) {
                return 'vCard';
            } else if (data.startsWith('bitcoin:') || data.startsWith('ethereum:')) {
                return 'Криптовалюта';
            } else {
                return 'Текст';
            }
        }
        
        // Добавить в историю генерации
        function addToHistory(item) {
            qrHistory.unshift(item);
            if (qrHistory.length > 50) qrHistory.pop();
            localStorage.setItem('qrHistory', JSON.stringify(qrHistory));
            loadHistory();
        }
        
        // Добавить в историю сканирования
        function addToScanHistory(item) {
            scanHistory.unshift(item);
            if (scanHistory.length > 50) scanHistory.pop();
            localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
            loadHistory();
        }
        
        // Загрузка истории
        function loadHistory() {
            // История генерации
            const genHistoryEl = document.getElementById('generationHistory');
            genHistoryEl.innerHTML = qrHistory.length > 0 
                ? qrHistory.map(item => `
                    <div class="history-item">
                        <div>
                            <strong>${item.type}</strong><br>
                            <small>${new Date(item.timestamp).toLocaleString()}</small>
                        </div>
                        <img src="${item.image}" width="50" height="50" alt="QR Code">
                    </div>
                `).join('')
                : '<p>История генерации пуста</p>';
            
            // История сканирования
            const scanHistoryEl = document.getElementById('scanHistory');
            scanHistoryEl.innerHTML = scanHistory.length > 0 
                ? scanHistory.map(item => `
                    <div class="history-item">
                        <div>
                            <strong>${item.type}</strong><br>
                            <small>${new Date(item.timestamp).toLocaleString()}</small><br>
                            ${item.content.length > 50 ? item.content.substring(0, 50) + '...' : item.content}
                        </div>
                    </div>
                `).join('')
                : '<p>История сканирования пуста</p>';
        }
        
        // Экранирование HTML
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
